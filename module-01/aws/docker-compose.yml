# LocalStack Docker Compose Configuration
# This file starts LocalStack with configurable settings via .env file
#
# Quick Start:
#   1. Copy .env.example to .env: cp .env.example .env
#   2. Adjust settings in .env as needed
#   3. Start LocalStack: docker compose up -d
#   4. View logs: docker compose logs -f localstack
#   5. Stop LocalStack: docker compose down

# Define Docker volumes for data persistence
volumes:
  localstack-data:
    driver: local
    name: localstack-data

services:
  localstack:
    container_name: ${LOCALSTACK_CONTAINER_NAME:-localstack-main}
    image: ${LOCALSTACK_IMAGE:-localstack/localstack:latest}
    ports:
      # LocalStack Gateway (Edge Port)
      - "127.0.0.1:${LOCALSTACK_EDGE_PORT:-4566}:4566"
      # External services port range
      - "127.0.0.1:4510-4559:4510-4559"
    environment:
      # === Core Configuration ===
      # Enable/disable debug mode (0 or 1)
      - DEBUG=${DEBUG:-0}
      # Enable/disable legacy behavior (0 or 1)
      - PROVIDER_LEGACY_FLAGS=${LOCALSTACK_PROVIDER_LEGACY_FLAGS:-1}

      # === Services to Enable ===
      # Comma-separated list of services or "all" for all services
      - SERVICES=${LOCALSTACK_SERVICES:-all}

      # === Persistence ===
      # Enable persistence (0 or 1)
      - PERSISTENCE=${PERSISTENCE:-1}
      - DATA_DIR=${LOCALSTACK_DATA_DIR:-/tmp/localstack/data}

      # === Network Configuration ===
      # DNS address for LocalStack (0 for default)
      - DNS_ADDRESS=${DNS_ADDRESS:-0}

      # === Security ===
      # Disable SSL certificate verification (for development only)
      - DISABLE_SSL_CHECKS=${DISABLE_SSL_CHECKS:-1}

      # === Edge Configuration ===
      # Edge port for LocalStack
      - EDGE_PORT=${LOCALSTACK_EDGE_PORT:-4566}

      # === Lambda Configuration ===
      # Lambda executor (docker, docker-reuse, or local)
      - LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR:-docker}

      # === LocalStack Pro (Optional) ===
      # Uncomment and add your auth token to enable Pro features
      # - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}

      # === Development/Testing ===
      # Return empty responses instead of errors for missing resources
      - EMPTY_PORT_ON_START=${EMPTY_PORT_ON_START:-1}
      # Enforce SSL verification (set to 1 for production-like behavior)
      - ENFORCE_SSL_CHECKS=${ENFORCE_SSL_CHECKS:-0}

    volumes:
      # Persist LocalStack data in a Docker volume
      - localstack-data:${LOCALSTACK_DATA_DIR:-/tmp/localstack/data}
      # Mount Docker socket for Docker-in-Docker (required for Lambda and ECS)
      # Windows (Docker Desktop): use ${DOCKER_SOCKET_PATH}
      # Linux/macOS: defaults to /var/run/docker.sock
      - ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock

    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          cpus: ${LOCALSTACK_CPU_LIMIT:-2.0}
          memory: ${LOCALSTACK_MEMORY_LIMIT:-2g}
        reservations:
          cpus: ${LOCALSTACK_CPU_RESERVATION:-0.5}
          memory: ${LOCALSTACK_MEMORY_RESERVATION:-512m}

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# Optional: Add a custom init container that waits for LocalStack to be ready
# This is useful for scripts that need to interact with LocalStack immediately
# init:
#   image: alpine:latest
#   depends_on:
#     localstack:
#       condition: service_healthy
#   command: >
#     sh -c "
#       echo 'LocalStack is ready!' &&
#       echo 'Edge endpoint: http://localhost:4566' &&
#       echo 'Health check: curl http://localhost:4566/_localstack/health'
#     "
#   restart: "no"
